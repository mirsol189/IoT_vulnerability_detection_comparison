#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#pragma warning(disable:4996)
#include <stdint.h>
#include <stddef.h>
#include <time.h>
#include <unistd.h>
#include <klee/klee.h>

void manageAccount();

typedef struct {

  char accountnumber[10];

  void(*print)(void*);

} Account;

typedef struct {

  char accountnumber[128];

} serverAccount;

void sendToServer(Account* account, serverAccount* serverside) {

  free(account);

  serverside = malloc(256);
  printf("주소값%p",manageAccount);
  printf("입력하신 계좌가 맞습니까? \n", manageAccount); 

  scanf("%128s", serverside->accountnumber);

  printf("처리된 계좌는 다음과 같습니다 : \n "); 
  account->print(account);

}

void captchaFinalStage() {

        int* captcha6 = (int*)malloc(sizeof(int));
  	printf("다음에 보이는 숫자를 입력해주세요 : -1284512\n");
	//scanf("%d", captcha6);
	klee_make_symbolic(captcha6, sizeof(int), "captcha12");
        if(*captcha6 == -1284512){
                int* captcha7 = (int*)malloc(sizeof(int));
  			printf("다음에 보이는 문자를 입력해주세요 : AF9381ty9hf9A*H6\n");
			//scanf("%s", captcha7);
			klee_make_symbolic(captcha7, sizeof(int), "captcha13");
                if(*captcha7 == -457457){
                        int* captcha8 = (int*)malloc(sizeof(int));
  			printf("다음에 보이는 숫자를 입력해주세요 : -952\n");
						//scanf("%d", captcha8);
			klee_make_symbolic(captcha8, sizeof(int), "captcha14");
                        if(*captcha8 == -952){
                                int one, two, three;
                                printf("숫자 3개 입력 해 주세요\n");
                                //scanf("%d %d %d", &one, &two, &three);
				klee_make_symbolic(&one, sizeof(int), "one");
				klee_make_symbolic(&two, sizeof(int), "two");
				klee_make_symbolic(&three, sizeof(int), "three");
                                int* hashTable = (int*)malloc(sizeof(int)*one);
                                int *lightHash = (int*)malloc(sizeof(int)*two);
                                int *heavyHash = (int*)malloc(sizeof(int)*three);
                                for (int i = 0; i < *lightHash; i++) {
                                        hashTable[i] = i;
                                        printf("%d ", hashTable[i]);
                                        if (i % 10 == 9)
                                        printf("\n");
                                }

                                free(hashTable);

                                for (int i = 0; i < *heavyHash; i++) {
                                        printf("%d ", hashTable[i]);
                                        if (i % 10 == 9)
                                                printf("\n");
                                }
                        }
                }
        }
}
void captchaFifthStage() {
  int* captcha = (int*)malloc(sizeof(int));
  printf("다음에 보이는 숫자를 입력해주세요 : 912627\n");
  //scanf("%d", captcha);
  klee_make_symbolic(captcha, sizeof(int), "captcha10");
  if (*captcha==912627) {
  	printf("다음에 보이는 숫자를 입력해주세요 : -9247\n");
        int* captcha5 = (int*)malloc(sizeof(int));
	  //scanf("%d", captcha5);
	  klee_make_symbolic(captcha5, sizeof(int), "captcha11");
        if(*captcha5 == -9247){
                captchaFinalStage();
        }
  }
}
void captchaFourthStage() {
  int* captcha = (int*)malloc(sizeof(int));
  printf("다음에 보이는 숫자를 입력해주세요 : 555\n");
  //scanf("%d", captcha);
  klee_make_symbolic(captcha, sizeof(int), "captcha8");
  if (*captcha==555) {
  	printf("다음에 보이는 숫자를 입력해주세요 : -3295613\n");
        int* captcha4 = (int*)malloc(sizeof(int));
	  //scanf("%d", captcha4);
	  klee_make_symbolic(captcha4, sizeof(int), "captcha9");
        if(*captcha4 == -3295613){
                captchaFifthStage();
        }
  }
}
void captchaThirdStage() {
  int* captcha = (int*)malloc(sizeof(int));
  printf("다음에 보이는 숫자를 입력해주세요 : 1234\n");
  //scanf("%d", captcha);
  klee_make_symbolic(captcha, sizeof(int), "captcha6");
  if (*captcha ==1234) {
        int* captcha3 = (int*)malloc(sizeof(int));
  	printf("다음에 보이는 숫자를 입력해주세요 : -239852\n");
	  //scanf("%d", captcha3);
	  klee_make_symbolic(captcha3, sizeof(int), "captcha7");
        if(*captcha3 == -239852){
                captchaFourthStage();
        }
  }
}
void captchaSecondStage() {
  int* captcha = (int*)malloc(sizeof(int));
  printf("다음에 보이는 숫자를 입력해주세요 : 10\n");
  //scanf("%d", captcha);
  klee_make_symbolic(captcha, sizeof(int), "captcha4");
  if (*captcha==10) {
	printf("다음에 보이는 숫자를 입력해주세요 : 192746\n");
        int* captcha2 = (int*)malloc(sizeof(int));
	  //scanf("%d", captcha2);
	  klee_make_symbolic(captcha2, sizeof(int), "captcha5");
        if(*captcha2 == 192746){

                captchaThirdStage();
        }
  }
}
void captchaFirstStage() {
  int* captcha = (int*)malloc(sizeof(int));
  printf("다음에 보이는 숫자를 입력해주세요 : 10\n");
  //scanf("%d", captcha);
  klee_make_symbolic(captcha, sizeof(int), "captcha2");
  if (*captcha ==10) {
        int* captcha1 = (int*)malloc(sizeof(int));
  	printf("다음에 보이는 숫자를 입력해주세요 : 28365\n");
	  	//scanf("%d", captcha1);
	klee_make_symbolic(captcha1, sizeof(int), "captcha3");
        if(*captcha1 == 28365){
                captchaSecondStage();
        }
  }
}
void printAccount(Account* account) {

  printf("%s\n", account->accountnumber);

}

void manageAccount(void) {//고객괸리-관리자용 함수

  FILE* fd = fopen("./userInfo.txt", "r");

  //printf("This is Shell\n");

  char* pstr;

  char strTemp[33];

  while (!feof(fd)) {

     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);

     //printf("%s",strTemp);

     char* a = strtok(strTemp, " ");

     char* b = strtok(NULL, " ");

     char* c = strtok(NULL, " ");

     char* d = strtok(NULL, " ");

     //printf("%s %s %s %s ",a, b, c, d);

     printf("%s", b);

  }

}

typedef enum { false, true } bool;

bool login(char* input_id, char* input_pw, char* compare_id, char* compare_pw, FILE* fd) {

  char* pstr;

  char strTemp[33];

  while (!feof(fd)) {

     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);

     compare_id = strtok(strTemp, " ");

     compare_pw = strtok(NULL, " ");

     if (!strncmp(input_id, compare_id,8)) {

        if (!strncmp(input_pw, compare_pw,8)) {

           return true;

        }

        else {

           return false;

        }

     }

     else

     {

        return false;

     }

  }

  return false;

}

bool compare(char* input_account, char* compare_account, char* compare_accountpw, FILE* fd) {


  char* pstr;

  char strTemp[33];

  rewind(fd);

  while (!feof(fd)) {

     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);
     strtok(strTemp, " ");
     strtok(NULL, " ");
     strcpy(compare_account, strtok(NULL, " "));

     if (strncmp(input_account, compare_account, 8) == 0) {

        strcpy(compare_accountpw, strtok(NULL, " "));

        return true;

     }

  }

  return false;

}

void send(char* input_id, char* input_pw, char* compare_id, char* compare_pw, char* input_account, char* compare_account,

                                                char* input_accountpw, char* compare_accountpw, FILE* fd)

{

     printf("아이디를 입력해주세요. \n ID : ");
     //scanf("%s", input_id);
     klee_make_symbolic(input_id, 8, "input_id");

     printf("비밀번호를 입력해주세요. \n PW : ");
     //scanf("%s", input_pw);
     klee_make_symbolic(input_pw, 8, "input_pw");


     if (login(input_id, input_pw, compare_id, compare_pw, fd)) {

        printf("입금하실 계좌를 입력해주세요. : \n");
        //scanf("%s", input_account);
        klee_make_symbolic(input_account, 8, "input_account");


        if (compare(input_account, compare_account, compare_accountpw, fd)) {

           Account* account;
           serverAccount* serverside = NULL;
           account = malloc(256);
           strcpy(account->accountnumber, compare_account);
           printf("입력하신 계좌는 다음과 같습니다. : \n");
           account->print = (void*)printAccount;
           account->print(account);
           sendToServer(account, serverside);

        }

     }

}

void delAccount()
{
     printf("계정 삭제를 원하시면 [delete!]라고 입력해주세요 : ");
     char* command = malloc(8);
     //scanf("%s", command);
     klee_make_symbolic(command, 8, "command");
     if (command[0] == 'd'&&command[1] == 'e'&&command[2] == 'l'&&command[3] == 'e' &&command[4] == 't'&& command[5] == 'e'&&command[6] == '!') {
        int* captcha = (int*)malloc(sizeof(int));;
        printf("다음 보이는 숫자를 입력해주세요 : 999\n");
        //scanf("%d", captcha);
	klee_make_symbolic(captcha, sizeof(int), "captcha1");
        if (*captcha == 999) {
           captchaFirstStage();
        }
}
}

int main(){


FILE* fd = fopen("./userInfo.txt", "r");

  if (fd == NULL){
        return -1;
  }
  char* input_id=malloc(sizeof(char)*8);
  char* input_pw=malloc(sizeof(char)*8);
  char* compare_id=malloc(sizeof(char)*8);
  char* compare_pw=malloc(sizeof(char)*8);
  char* input_account=malloc(sizeof(char)*8);
  char* compare_accountpw=malloc(sizeof(char)*4);
  char* compare_account=malloc(sizeof(char)*8);
  char* input_accountpw=malloc(sizeof(char)*4);
  printf("환영합니다! 원하시는 거래를 선택하세요. 1:송금하기 2:계정삭제 \n");
    int dealnum;
   //scanf("%d", &dealnum);
  klee_make_symbolic(&dealnum, sizeof(int), "dealnum");
  if (dealnum == 1) {
        send(input_id, input_pw, compare_id, compare_pw, input_account, compare_account, input_accountpw, compare_accountpw, fd);
  }
  else if (dealnum == 2) {
     delAccount();
  }
else {
     printf("잘못된 입력입니다.");
     return 0;
  }
  //system("pause");
}
