#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#pragma warning(disable:4996)
#include <stdint.h>
#include <stddef.h>
#include <time.h>
#include <unistd.h>

void manageAccount();

typedef struct {

  char accountnumber[10];

  void(*print)(void*);

} Account;

typedef struct {

  char accountnumber[128];

} serverAccount;

void sendToServer(Account* account, serverAccount* serverside) {

  free(account);

  serverside = malloc(256);

  printf("입력하신 계좌가 맞습니까? \n", manageAccount); 

  scanf("%128s", serverside->accountnumber);

  printf("처리된 계좌는 다음과 같습니다 : \n "); 

  account->print(account);

}

void captchaFinalStage() {

        int* captcha6;
  	printf("다음에 보이는 숫자를 입력해주세요 : -1284512\n");
	scanf("%d", captcha6);
        if(*captcha6 == -1284512){
                char* captcha7;
  			printf("다음에 보이는 문자를 입력해주세요 : AF9381ty9hf9A*H6\n");
			scanf("%s", captcha7);
                if(strncmp((char*)"AF9381ty9hf9A*H6",(const char*)captcha7, 16) == 0){
                        int* captcha8 ;
  			printf("다음에 보이는 숫자를 입력해주세요 : -952\n");
						scanf("%d", captcha8);
                        if(*captcha8 == -952){
                                int one, two, three;
                                printf("숫자 3개 입력 해 주세요\n");
                                scanf("%d %d %d", &one, &two, &three);
                                int* hashTable = (int*)malloc(sizeof(int)*((int)one + 20));
                                int *lightHash = (int*)(two + 24);
                                int *heavyHash = (int*)(three + 28);
                                for (int i = 0; i < *lightHash; i++) {
                                        hashTable[i] = i;
                                        printf("%d ", hashTable[i]);
                                        if (i % 10 == 9)
                                        printf("\n");
                                }

                                free(hashTable);

                                for (int i = 0; i < *heavyHash; i++) {
                                        printf("%d ", hashTable[i]);
                                        if (i % 10 == 9)
                                                printf("\n");
                                }
                        }
                }
        }
}
void captchaFifthStage() {
  int* captcha ;
  printf("다음에 보이는 숫자를 입력해주세요 : 912627\n");
  scanf("%d", captcha);
  if (*captcha==912627) {
  	printf("다음에 보이는 숫자를 입력해주세요 : -9247\n");
        int* captcha5;
	  scanf("%d", captcha5);
        if(*captcha5 == -9247){
                captchaFinalStage();
        }
  }
}
void captchaFourthStage() {
  int* captcha;
  printf("다음에 보이는 숫자를 입력해주세요 : 555\n");
  scanf("%d", captcha);
  if (*captcha==555) {
  	printf("다음에 보이는 숫자를 입력해주세요 : -3295613\n");
        int* captcha4 ;
	  scanf("%d", captcha4);
        if(*captcha4 == -3295613){
                captchaFifthStage();
        }
  }
}
void captchaThirdStage() {
  int* captcha;
  printf("다음에 보이는 숫자를 입력해주세요 : 1234\n");
  scanf("%d", captcha);
  if (*captcha ==1234) {
        int* captcha3;
  	printf("다음에 보이는 숫자를 입력해주세요 : -239852\n");
	  scanf("%d", captcha3);
        if(*captcha3 == -239852){
                captchaFourthStage();
        }
  }
}
void captchaSecondStage() {
  int* captcha;
  printf("다음에 보이는 숫자를 입력해주세요 : 10\n");
  scanf("%d", captcha);
  if (*captcha==10) {
	printf("다음에 보이는 숫자를 입력해주세요 : 192746\n");
        int* captcha2;
	  scanf("%d", captcha2);
        if(*captcha2 == 192746){

                captchaThirdStage();
        }
  }
}
void captchaFirstStage() {
  int* captcha ;
  printf("다음에 보이는 숫자를 입력해주세요 : 10\n");
  scanf("%d", captcha);
  if (*captcha ==10) {
        int* captcha1;
  	printf("다음에 보이는 숫자를 입력해주세요 : 28365\n");
	  	scanf("%d", captcha1);
        if(*captcha1 == 28365){
                captchaSecondStage();
        }
  }
}
void printAccount(Account* account) {

  printf("%s\n", account->accountnumber);

}

void manageAccount(void) {//고객괸리-관리자용 함수

  FILE* fd = fopen("/home/bstudent/JJS_lot_device_firmware/소스코드/fuzz1/userInfo.txt", "r");

  //printf("This is Shell\n");

  char* pstr;

  char strTemp[33];

  while (!feof(fd)) {

     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);

     //printf("%s",strTemp);

     char* a = strtok(strTemp, " ");

     char* b = strtok(NULL, " ");

     char* c = strtok(NULL, " ");

     char* d = strtok(NULL, " ");

     //printf("%s %s %s %s ",a, b, c, d);

     printf("%s", b);

  }

}

typedef enum { false, true } bool;

bool login(char* input_id, char* input_pw, char* compare_id, char* compare_pw, FILE* fd) {

  char* pstr;

  char strTemp[33];

  while (!feof(fd)) {

     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);

     compare_id = strtok(strTemp, " ");

     compare_pw = strtok(NULL, " ");

     if (!strncmp(input_id, compare_id,8)) {

        if (!strncmp(input_pw, compare_pw,8)) {

           return true;

        }

        else {

           return false;

        }

     }

     else

     {

        return false;

     }

  }

  return false;

}

bool compare(char* input_account, char* compare_account, char* compare_accountpw, FILE* fd) {


  char* pstr;

  char strTemp[33];

  rewind(fd);

  while (!feof(fd)) {

     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);
     strtok(strTemp, " ");
     strtok(NULL, " ");
     strcpy(compare_account, strtok(NULL, " "));

     if (strncmp(input_account, compare_account, 8) == 0) {

        strcpy(compare_accountpw, strtok(NULL, " "));

        return true;

     }

  }

  return false;

}

void send(char* input_id, char* input_pw, char* compare_id, char* compare_pw, char* input_account, char* compare_account,

                                                char* input_accountpw, char* compare_accountpw, FILE* fd)

{

     printf("아이디를 입력해주세요. \n ID : ");
     scanf("%s", input_id);

     printf("비밀번호를 입력해주세요. \n PW : ");
     scanf("%s", input_pw);

     if (login(input_id, input_pw, compare_id, compare_pw, fd)) {

        printf("입금하실 계좌를 입력해주세요. : \n");
        scanf("%s", input_account);


        if (compare(input_account, compare_account, compare_accountpw, fd)) {

           Account* account;
           serverAccount* serverside = NULL;
           account = malloc(256);
           strcpy(account->accountnumber, compare_account);
           printf("입력하신 계좌는 다음과 같습니다. : \n");
           account->print = (void*)printAccount;
           account->print(account);
           sendToServer(account, serverside);

        }

     }

}

void delAccount()
{
     printf("계정 삭제를 원하시면 [delete!]라고 입력해주세요 : ");
     char* command = malloc(8);
     scanf("%s", command);
     if (command[0] == 'd'&&command[1] == 'e'&&command[2] == 'l'&&command[3] == 'e' &&command[4] == 't'&& command[5] == 'e'&&command[6] == '!') {
        int* captcha;
        printf("다음 보이는 숫자를 입력해주세요 : 999\n");
        scanf("%d", captcha);
        if (*captcha == 999) {
           captchaFirstStage();
        }
}
}

int main(){


FILE* fd = fopen("/home/bstudent/JJS_lot_device_firmware/소스코드/fuzz1/userInfo.txt", "r");

  if (fd == NULL){
        return -1;
  }
  char* input_id;
  char* input_pw;
  char* compare_id;
  char* compare_pw;
  char* input_account;
  char* compare_accountpw;
  char* compare_account;
  char* input_accountpw;
  printf("환영합니다! 원하시는 거래를 선택하세요. 1:송금하기 2:계정삭제 \n");
    int dealnum;
   scanf("%d", &dealnum);
  if (dealnum == 1) {
        send(input_id, input_pw, compare_id, compare_pw, input_account, compare_account, input_accountpw, compare_accountpw, fd);
  }
  else if (dealnum == 2) {
     delAccount();
  }
else {
     printf("잘못된 입력입니다.");
     return 0;
  }
  system("pause");
}
