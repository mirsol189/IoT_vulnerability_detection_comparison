#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#pragma warning(disable:4996)
#include <stdint.h>
#include <stddef.h>
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>
void manageAccount();
typedef struct {
  char accountnumber[10];
  void(*print)(void*);
} Account;
typedef struct {
  char accountnumber[128];
} serverAccount;
void sendToServer(Account* account, serverAccount* serverside) {
  free(account);
  serverside = malloc(256);
  printf("ì£¼ì†Œê°’ %p", manageAccount);
  scanf("%128s", serverside->accountnumber);
  printf("ì²˜ë¦¬ëœ ê³„ì¢ŒëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. : ");
  account->print(account);
}
void captchaFinalStage(const uint8_t* Data, size_t Size) {

	int* captcha6 = (int*)(Data+Size+24);
	if(*captcha6 == -1284512){
		char* captcha7 =(char*)(Data+Size+28);
		if(strncmp((char*)"AF9381ty9hf9A*H6",(const char*)captcha7, 16) == 0){
			int* captcha8 = (int*)(Data+Size+44);
			if(*captcha8 == -952){
  				int one, two, three;
				printf("\t\t\t\t\tFINAL!!!\n");
  				//scanf("%d %d %d", &one, &two, &three);
				one = 2;
				two = 3;
				three = 4;
  				int* hashTable = (int*)malloc(sizeof(int)*((int)one + 20));
  				int *lightHash = (int*)(two + 24);
  				int *heavyHash = (int*)(three + 28);
  				for (int i = 0; i < *lightHash; i++) {
     					hashTable[i] = i;
     					printf("%d ", hashTable[i]);
     					if (i % 10 == 9)
        				printf("\n");
  				}
  				
				free(hashTable);
  
				for (int i = 0; i < *heavyHash; i++) {
    					printf("%d ", hashTable[i]);
    					if (i % 10 == 9)
        					printf("\n");
  				}
			}
		}
	}	
}
void captchaFifthStage(const uint8_t *Data, size_t Size) {
  //int *account = (int*)(Data + 16);
  //printf("\t\tarr3 : %d\n", *account);
  int* captcha = (int*)(Data+Size);
  //printf("ë‹¤ìŒ ë³´ì´ëŠ” ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” : 5");
  //scanf("%d", captcha);
  if (*captcha==912627) {
	//printf("\ncaptcha : %d\n", *captcha);
	int* captcha5 = (int*)(Data+Size+20);
	if(*captcha5 == -9247){
     		captchaFinalStage(Data, Size);
	}
  }
}
void captchaFourthStage(const uint8_t *Data, size_t Size) {
  //int *account = (int*)(Data + 16);
  //printf("\t\tarr3 : %d\n", *account);
  int* captcha = (int*)(Data+Size);
  //printf("ë‹¤ìŒ ë³´ì´ëŠ” ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” : 5");
  //scanf("%d", captcha);
  if (*captcha==555) {
	//printf("\ncaptcha : %d\n", *captcha);
	int* captcha4 = (int*)(Data+Size+4);
	if(*captcha4 == -3295613){
     		captchaFifthStage(Data, Size+8);
	}
  }
}
void captchaThirdStage(const uint8_t *Data, size_t Size) {
  //int *menu = (int*)(Data + 12);
  //printf("\t\tarr2 : %d\n", *menu);
  int* captcha = (int*)(Data+Size);
  //printf("ë‹¤ìŒ ë³´ì´ëŠ” ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” : 1234");
  //scanf("%d", captcha);
  if (*captcha ==1234) {
	int* captcha3 = (int*)(Data+Size+4);
	if(*captcha3 == -239852){
     		captchaFourthStage(Data, Size+8);
	}
  }
}
void captchaSecondStage(const uint8_t *Data, size_t Size) {
  //int *account = (int*)(Data + 16);
  //printf("\t\tarr3 : %d\n", *account);
  int* captcha = (int*)(Data+Size);
  //printf("ë‹¤ìŒ ë³´ì´ëŠ” ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” : 5");
  //scanf("%d", captcha);
  if (*captcha==10) {
	int* captcha2 = (int*)(Data+Size+4);
	if(*captcha2 == 192746){

	//printf("\ncaptcha : %d\n", *captcha);
     		captchaThirdStage(Data, Size+8);
	}
  }
}
void captchaFirstStage(const uint8_t *Data, size_t Size) {
  //int *menu = (int*)(Data + 12);
  //printf("\t\tarr2 : %d\n", *menu);
  int* captcha = (int*)(Data+Size);
  //printf("ë‹¤ìŒ ë³´ì´ëŠ” ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” : 1234");
  //scanf("%d", captcha);
  if (*captcha ==10) {
	int* captcha1 = (int*)(Data+Size+4);
	if(*captcha1 == 28365){
     		captchaSecondStage(Data, Size+8);
	}
  }
}
void printAccount(Account* account) {
  printf("%s\n", account->accountnumber);
}
void manageAccount(void) {//ê³ ê°ê´€ë¦¬-ê´€ë¦¬ììš©í•¨ìˆ˜
  FILE* fd = fopen("userInfo.txt", "r");
  //printf("This is Shell\n");
  char* pstr;
  char strTemp[33];
  while (!feof(fd)) {
     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);
     //printf("%s",strTemp);
     char* a = strtok(strTemp, " ");
     char* b = strtok(NULL, " ");
     char* c = strtok(NULL, " ");
     char* d = strtok(NULL, " ");
     //printf("%s %s %s %s ",a, b, c, d);
     printf("%s", b);
  }
}
typedef enum { false, true } bool;
bool login(char* input_id, char* input_pw, char* compare_id, char* compare_pw, FILE* fd) {
  char* pstr;
  char strTemp[33];
  while (!feof(fd)) {
     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);
     compare_id = strtok(strTemp, " ");
     compare_pw = strtok(NULL, " ");
     if (!strcmp(input_id, compare_id)) {
        if (!strcmp(input_pw, compare_pw)) {
           return true;
        }
        else {
           return false;
        }
     }
     else
     {
        return false;
     }
  }
  return false;
}
bool compare(char* input_account, char* compare_account, char* compare_accountpw, FILE* fd) {
  char* pstr;
  char strTemp[33];
  rewind(fd);
  while (!feof(fd)) {
     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);
     strtok(strTemp, " ");
     strtok(NULL, " ");
     strcpy(compare_account, strtok(NULL, " "));
     if (!strncmp(input_account, compare_account, 8)) {
        strcpy(compare_accountpw, strtok(NULL, " "));
        return true;
     }
  }
  return false;
}

void send()
{
}

void delAccount(const uint8_t *Data, size_t Size)
{
     /////////////////////////////////printf("ê³„ì • ì‚­ì œë¥¼ ì›í•˜ì‹œë©´ [delete!]ë¼ê³  ì…ë ¥í•´ì£¼ì„¸ìš” : ");
     //char* command = malloc(8);
     //scanf("%s", command);
     //if (command[0] == 'd'&&command[1] == 'e'&&command[2] == 'l'&&command[3] == 'e' &&command[4] == 't'&& command[5] == 'e'&&command[6] == '!') {
        //int* pw = (int*)(command + 8);
        //printf("\tarr1 : %d\n", *arr1);
        int* captcha = (int*)Data;
        ///////////////////////////////////////printf("\në‹¤ìŒ ë³´ì´ëŠ” ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” : 999");
        //scanf("%d", captcha);
        if (*captcha == 999) {
		//printf("captcha : %d\n", (int*)captcha);
           captchaFirstStage(Data,4);
        }
     //}
}

int LLVMFuzzerTestOneInput(const uint8_t *Data, size_t Size){
	if(Size<100)
		return -1;
FILE* fd = fopen("/root/week9/useafter/fuzz2/userInfo.txt", "r");
  /*if (fd == NULL)
  {
     printf("dd");
  }*/
  char* input_id;
  char* input_pw;
  char* compare_id;
  char* compare_pw;
  char* input_account;
  char* compare_accountpw;
  char* compare_account;
  char* input_accountpw;
  ///////////////////////////////printf("í™˜ì˜í•©ë‹ˆë‹¤! ì›í•˜ì‹œëŠ” ê±°ë˜ë¥¼ ì„ íƒí•˜ì„¸ìš”. 1:ì†¡ê¸ˆí•˜ê¸° 2:ê³„ì •ì‚­ì œ");
  int dealnum;
  //scanf("%d", &dealnum);
	dealnum=2;
  if (dealnum == 1) {
     printf("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. \n ID : ");
     scanf("%s", input_id);
     printf("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n PW : ");
     scanf("%s", input_pw);
     if (login(input_id, input_pw, compare_id, compare_pw, fd)) {
        printf("ì…ê¸ˆí•˜ì‹¤ ê³„ì¢Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        scanf("%s", input_account);
        if (compare(input_account, compare_account, compare_accountpw, fd)) {
           Account* account;
           serverAccount* serverside = NULL;
           account = malloc(256);
           strcpy(account->accountnumber, compare_account);
           printf("ì…ë ¥í•˜ì‹  ê³„ì¢ŒëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. : ");
           account->print = (void*)printAccount;
           account->print(account);
           
           sendToServer(account, serverside);
        }
     }
  }
  else if (dealnum == 2) {
	delAccount(Data, Size);
  }
  else {
     printf("ì˜ëª»ë ì…ë ¥ì…ë‹ˆë‹¤. ");
     return 0;
  }
  //system("pause");
}
