#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#pragma warning(disable:4996)
#include <stdint.h>
#include <stddef.h>
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>


int MyStringNCompare(const char *ap_string1, const char *ap_string2, unsigned int a_length)
{
	unsigned int i;
	for(i=0; i<a_length-1; i++)
	{
		if(*ap_string1 != *ap_string2) break;

		if(*ap_string1 == 0 || *ap_string2 == 0) break;
		
		ap_string1++;
		ap_string2++;
		
	}

	if(*ap_string1 == *ap_string2) return 0;
	else if(*ap_string1 > *ap_string2) return 1;
	return -1;
}

void manageAccount();
typedef struct {
  char accountnumber[10];
  void(*print)(void*);
} Account;
typedef struct {
  char accountnumber[128];
} serverAccount;
void sendToServer(Account* account, serverAccount* serverside) {
  free(account);
  serverside = malloc(256);
  printf("Ï£ºÏÜåÍ∞í %p", manageAccount);
  scanf("%128s", serverside->accountnumber);
  printf("Ï≤òÎ¶¨Îêú Í≥ÑÏ¢åÎäî Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§. : ");
  account->print(account);
}
void captchaFinalStage() {
  int one, two, three;
  scanf("%d %d %d", &one, &two, &three);
  int* hashTable = (int*)malloc(sizeof(int)*((int)one + 20));
  int *lightHash = (int*)(two + 24);
  int *heavyHash = (int*)(three + 28);
  for (int i = 0; i < *lightHash; i++) {
     hashTable[i] = i;
     printf("%d ", hashTable[i]);
     if (i % 10 == 9)
        printf("\n");
  }
  free(hashTable);
  for (int i = 0; i < *heavyHash; i++) {
     printf("%d ", hashTable[i]);
     if (i % 10 == 9)
        printf("\n");
  }
}
void captchaSecondStage() {
  //int *account = (int*)(Data + 16);
  //printf("\t\tarr3 : %d\n", *account);
  int* captcha = malloc(1);
  printf("Îã§Ïùå Î≥¥Ïù¥Îäî Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî : 5");
  scanf("%d", captcha);
  if (*captcha==5) {
     captchaFinalStage();
  }
}
void captchaFirstStage() {
  //int *menu = (int*)(Data + 12);
  //printf("\t\tarr2 : %d\n", *menu);
  int* captcha = malloc(1);
  printf("Îã§Ïùå Î≥¥Ïù¥Îäî Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî : 1234");
  scanf("%d", captcha);
  if (*captcha ==1234) {
     captchaSecondStage();
  }
}
void printAccount(Account* account) {
  printf("%s\n", account->accountnumber);
}
void manageAccount(void) {//Í≥†Í∞ùÍ¥ÄÎ¶¨-Í¥ÄÎ¶¨ÏûêÏö©Ìï®Ïàò
  FILE* fd = fopen("/root/week9/useafter/fuzz1/userInfo.txt", "r");
  //printf("This is Shell\n");
  char* pstr;
  char strTemp[33];
  while (!feof(fd)) {
     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);
     //printf("%s",strTemp);
     char* a = strtok(strTemp, " ");
     char* b = strtok(NULL, " ");
     char* c = strtok(NULL, " ");
     char* d = strtok(NULL, " ");
     //printf("%s %s %s %s ",a, b, c, d);
     printf("%s", b);
  }
}
typedef enum { false, true } bool;
bool login(char* input_id, char* input_pw, char* compare_id, char* compare_pw, FILE* fd) {
  char* pstr;
  char strTemp[33];
  while (!feof(fd)) {
     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);
     compare_id = strtok(strTemp, " ");
     compare_pw = strtok(NULL, " ");
     if (!/*MyStringNCompare*/strncmp(input_id, compare_id,8)) {
        if (!/*MyStringNCompare*/strncmp(input_pw, compare_pw,8)) {
           return true;
        }
        else {
           return false;
        }
     }
     else
     {
        return false;
     }
  }
  return false;
}
bool compare(char* input_account, char* compare_account, char* compare_accountpw, FILE* fd) {
	//if(strlen(input_account) <= 8)
	//	return false;
	//printf("\ninput acc : %.8s", input_account);
  char* pstr;
  char strTemp[33];
  rewind(fd);
	compare_account="21249115";
	//printf("com acc : %s\ninput acc : %s\n",compare_account, input_account);
  while (!feof(fd)) {
     pstr = fgets(strTemp, sizeof(strTemp) + 1, fd);
     //compare_account = strtok(strTemp, " ");
     //compare_account = strtok(NULL, " ");
	//compare_account = strtok(NULL, " ");
	//printf("com : %s\ninput : %.8s\n",compare_account,input_account);
     //strcpy(compare_account, strtok(NULL, " "));
     if (strncmp(input_account, compare_account, 8) == 0) {
        //strcpy(compare_accountpw, strtok(NULL, " "));
        return true;
     }
  }
  return false;
}

void send(const uint8_t *Data, size_t Size, char* input_id, char* input_pw, char* compare_id, char* compare_pw, char* input_account, char* compare_account, 
						char* input_accountpw, char* compare_accountpw, FILE* fd)
{
     //printf("ÏïÑÏù¥ÎîîÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. \n ID : ");
     //scanf("%s", input_id);
     //printf("ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.\n PW : ");
     //scanf("%s", input_pw);

	input_id = (char*)Data;
	input_pw = (char*)(Data+8);

	
     if (login(input_id, input_pw, compare_id, compare_pw, fd)) {
        //printf("ÏûÖÍ∏àÌïòÏã§ Í≥ÑÏ¢åÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
        //scanf("%s", input_account);
	input_account = (char*)(Data+16);
	//input_account="21249115";
        if (compare(input_account, compare_account, compare_accountpw, fd)) {
	//	printf("\nÏïºÌò∏\n");
           Account* account;
           serverAccount* serverside = NULL;
           account = malloc(256);
           //strcpy(account->accountnumber, compare_account);
           printf("ÏûÖÎ†•ÌïòÏã† Í≥ÑÏ¢åÎäî Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§. : ");
           account->print = (void*)printAccount;
           account->print(account);
           
           sendToServer(account, serverside);
        }
     }
}

int LLVMFuzzerTestOneInput(const uint8_t *Data, size_t Size){
	if(Size < 100)
		return -1;
FILE* fd = fopen("/root/week9/useafter/fuzz1/userInfo.txt", "r");
  if (fd == NULL)
  {
	return -1;
  }
  char* input_id;
  char* input_pw;
  char* compare_id;
  char* compare_pw;
  char* input_account;
  char* compare_accountpw = malloc(4);
  char* compare_account = malloc(8);
  char* input_accountpw = malloc(4);
  //printf("ÌôòÏòÅÌï©ÎãàÎã§! ÏõêÌïòÏãúÎäî Í±∞ÎûòÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. 1:ÏÜ°Í∏àÌïòÍ∏∞ 2:Í≥ÑÏ†ïÏÇ≠Ï†ú");
  int dealnum;
	dealnum = 1;
 // scanf("%d", &dealnum);
  if (dealnum == 1) {
	send(Data, Size, input_id, input_pw, compare_id, compare_pw, input_account, compare_account, input_accountpw, compare_accountpw, fd);
  }
  else if (dealnum == 2) {
     printf("Í≥ÑÏ†ï ÏÇ≠Ï†úÎ•º ÏõêÌïòÏãúÎ©¥ [delete!]ÎùºÍ≥† ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî : ");
     char* command = malloc(8);
     //scanf("%s", command);
     if (command[0] == 'd'&&command[1] == 'e'&&command[2] == 'l'&&command[3] == 'e' &&command[4] == 't'&& command[5] == 'e'&&command[6] == '!') {
        //int* pw = (int*)(command + 8);
        //printf("\tarr1 : %d\n", *arr1);
        int* captcha = (int*)Data;
        printf("Îã§Ïùå Î≥¥Ïù¥Îäî Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî : 999");
        //scanf("%d", captcha);
        if (*captcha == 999) {
           captchaFirstStage();
        }
     }
  }
  else {
     printf("ÏûòÎ™ªÎ ÏûÖÎ†•ÏûÖÎãàÎã§. ");
     return 0;
  }

	//free(input_id);
	//free(input_pw);
	//free(compare_id);
	//free(compare_pw);
	//free(input_account);
	free(compare_accountpw);
	free(compare_account);
	free(input_accountpw);
  //system("pause");
}
